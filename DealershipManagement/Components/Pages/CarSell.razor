@page "/car/{Id}/sell"

<PageTitle>Sell Car - Dealership Management</PageTitle>

@if (car == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/cars">Cars</a></li>
                        <li class="breadcrumb-item"><a href="/car/@car.Id">@car.Year @car.Make @car.Model</a></li>
                        <li class="breadcrumb-item active">Sell</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4>Sell Car: @car.Year @car.Make @car.Model</h4>
                    </div>
                    <div class="card-body">
                        @if (car.IsSold)
                        {
                            <div class="alert alert-warning" role="alert">
                                <h5 class="alert-heading">Car Already Sold!</h5>
                                <p>This car was sold on @car.SellDate?.ToString("MMM dd, yyyy") for @car.SellPrice.ToString("C").</p>
                                <hr>
                                <a href="/car/@car.Id" class="btn btn-primary">View Car Details</a>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="saleInfo" OnValidSubmit="HandleSubmit">
                                <DataAnnotationsValidator />
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="sellPrice" class="form-label">Sale Price *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <InputNumber id="sellPrice" class="form-control" @bind-Value="saleInfo.SellPrice" />
                                        </div>
                                        <ValidationMessage For="@(() => saleInfo.SellPrice)" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="sellDate" class="form-label">Sale Date *</label>
                                        <InputDate id="sellDate" class="form-control" @bind-Value="saleInfo.SellDate" />
                                        <ValidationMessage For="@(() => saleInfo.SellDate)" />
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                                        @if (isSubmitting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        }
                                        <span class="oi oi-dollar"></span> Complete Sale
                                    </button>
                                    <a href="/car/@car.Id" class="btn btn-secondary">Cancel</a>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Car Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-6">VIN:</dt>
                            <dd class="col-sm-6">@car.VIN</dd>
                            
                            <dt class="col-sm-6">Stock #:</dt>
                            <dd class="col-sm-6">@car.StockNumber</dd>
                            
                            <dt class="col-sm-6">Buy Price:</dt>
                            <dd class="col-sm-6">@car.BuyPrice.ToString("C")</dd>
                            
                            <dt class="col-sm-6">Buy Date:</dt>
                            <dd class="col-sm-6">@(car.BuyDate?.ToString("MMM dd, yyyy") ?? "Not set")</dd>
                            
                            <dt class="col-sm-6">Tax:</dt>
                            <dd class="col-sm-6">@car.Tax.ToString("C")</dd>
                            
                            <dt class="col-sm-6">Final Buy Price:</dt>
                            <dd class="col-sm-6">@car.FinalBuyPrice.ToString("C")</dd>
                        </dl>
                    </div>
                </div>

                @if (!car.IsSold)
                {
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Sale Preview</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-6">Sale Price:</dt>
                                <dd class="col-sm-6">@saleInfo.SellPrice.ToString("C")</dd>
                                
                                <dt class="col-sm-6">Tax (10%):</dt>
                                <dd class="col-sm-6">@((saleInfo.SellPrice * 0.10m).ToString("C"))</dd>
                                
                                <dt class="col-sm-6">Final Sale Price:</dt>
                                <dd class="col-sm-6">@((saleInfo.SellPrice * 1.10m).ToString("C"))</dd>
                                
                                <dt class="col-sm-6">Profit:</dt>
                                <dd class="col-sm-6">
                                    <span class="@(saleInfo.SellPrice > car.BuyPrice ? "text-success" : "text-danger")">
                                        @((saleInfo.SellPrice - car.BuyPrice).ToString("C"))
                                    </span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}
